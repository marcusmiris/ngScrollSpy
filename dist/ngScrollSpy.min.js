/*
Copyright (c) 2014 Magnús Örn Gylfason
Licence: MIT
*/
!function(t){"use strict";function e(){return o}var n=t.module("ngScrollSpy",[]);n.service("ScrollSpy",["$window",function(e){var n,o=function(e){var n=t.element(e),o=n.innerWidth()||document.documentElement.clientWidth||document.body.clientWidth,i=n.innerHeight()||document.documentElement.clientHeight||document.body.clientHeight,r=void 0!==e.pageXOffset,l="CSS1Compat"===(document.compatMode||""),s=(r?e.pageXOffset:l?document.documentElement.scrollLeft:document.body.scrollLeft,r?e.pageYOffset:l?document.documentElement.scrollTop:document.body.scrollTop,{width:o,height:i,maxWidth:e.scrollWidth,maxHeight:e.scrollHeight,posX:n.scrollLeft()||e.pageXOffset||document.documentElement.scrollLeft,posY:n.scrollTop()||e.pageYOffset||document.documentElement.scrollTop});return s.posX<0?(s.posX=0,s.overscrollLeft=!0):s.posX+s.width>s.maxWidth&&(s.posX=s.maxWidth-s.width,s.overscrollRight=!0),s.posY<0?(s.posY=0,s.overscrollTop=!0):s.posY+s.height>s.maxHeight&&(s.posY=s.maxHeight-s.height,s.overscrollBottom=!0),s.hasOverscroll=s.overscrollTop||s.overscrollBottom||s.overscrollLeft||s.overscrollRight,s},i=function(e,n){if(!e||!n)return t.extend({isEqual:!1,velocityX:0,velocityY:0},n);var o={posX:n.posX-e.posX,posY:n.posY-e.posY,width:n.width-e.width,height:n.height-e.height,maxWidth:n.maxWidth-e.maxWidth,maxHeight:n.maxHeight-e.maxHeight};return n.width>0&&(o.velocityX=o.posX/n.width),n.height>0&&(o.velocityY=o.posY/n.height),o.isEqual=!(0!==o.posX||0!==o.posY||0!==o.width||0!==o.height||0!==o.maxWidth||0!==o.maxHeight),o},r={},l=function(e){var l=o(t.element("#content")[0]),s=i(n,l);if(!s.isEqual||l.hasOverscroll||e){for(var c in r){var u=r[c].cond;(u(l,s)||e)&&r[c].handler(l,s)}n=l}};t.element(t.element("#content")).on("scroll",l);var s=this,c=0;this.trigger=function(){this.isForced=!0,l(!0),this.isForced=!1},this.addHandler=function(t,e){return r[c]={cond:t,handler:e},c++,c-1},this.removeHandler=function(t){delete r[t]},this.onScroll=function(t){return s.addHandler(function(){return!0},function(e,n){t(e,n)})},this.onXScroll=function(t){return s.addHandler(function(t,e){return 0!==e.posX},function(e,n){t(e.posX,n.posX,e,n)})},this.onYScroll=function(t){return s.addHandler(function(t,e){return 0!==e.posY},function(e,n){t(e.posY,n.posY,e,n)})},this.onOverscrollHorz=function(t){return s.addHandler(function(t,e){return t.overscrollLeft||t.overscrollRight},t)},this.onOverscrollLeft=function(t){return s.addHandler(function(t,e){return t.overscrollLeft},t)},this.onOverscrollRight=function(t){return s.addHandler(function(t,e){return t.overscrollRight},t)},this.onOverscrollVert=function(t){return s.addHandler(function(t,e){return t.overscrollTop||t.overscrollBottom},t)},this.onOverscrollTop=function(t){return s.addHandler(function(t,e){return t.overscrollTop},t)},this.onOverscrollBottom=function(t){return s.addHandler(function(t,e){return t.overscrollBottom},t)}}]),n.directive("affix",["ScrollSpy",function(t){var e,n=function(t,e,n,o){var i=t(o[0].getBoundingClientRect());i!==e&&(i?o.addClass(n):o.removeClass(n))},o=function(o,i,r){var l,s=!1,c=!1,u=!1;"top"===o?e=t.onYScroll(function(t){c=s,n(function(e){return s?s=t>=l:e.top<=0?(l=e.top<0?t+e.top:t,s=!0):!1},c,i,r)}):"bottom"===o?(u=!0,e=t.onYScroll(function(e,o,u){c=s,n(function(n){return s?s=l>=e:n.bottom>=u.height?(l=t.isForced&&0===e?e+n.bottom-u.height-n.height:e+n.bottom-u.height,s=!0):!1},c,i,r)})):"left"===o?e=t.onXScroll(function(t){c=s,n(function(e){return s?s=t>=l:e.left<=0?(l=e.left<0?t+e.left:t,s=!0):!1},c,i,r)}):"right"===o&&(u=!0,e=t.onXScroll(function(e,o,u){c=s,n(function(n){return s?s=l>=e:n.right>=u.width?(l=t.isForced&&0===e?e+n.right-u.width-n.width:e+n.right-u.width,s=!0):!1},c,i,r)})),u&&t.trigger()};return{restrict:"A",scope:{affix:"@",affixClass:"@"},link:function(n,i,r,l){n.affix=n.affix||"top",n.affixClass=n.affixClass||"affix",o(n.affix,n.affixClass,i),n.$on("destroy",function(){t.removeHandler(e)})}}}]);var o={onRun:null,state:null,store:function(t){for(var e in t)this[e]=t[e];this.state=!0,this.run()},builder:null,setBuilder:function(t){this.builder=t,this.run()},run:function(){this.builder&&this.state&&(this.builder(),this.builder=null,this.state=null,this.onRun&&(this.onRun(),this.onRun=null))}};n.directive("pageitems",["ScrollSpy",function(n){var o=function(o,i,r){if(t.isDefined(o.selector)){o.spyElems=i[0].getElementsByClassName(o.selector),o.spies={},e().onRun=function(){o.spies[o.spyElems[0].id].set()},e().store({topMargin:function(){return 0|o.topmargin},addSpy:function(t){o.spies[t.id]=t},getSpy:function(t){return o.spies[t]},items:function(){return o.spyElems}});var l=o.spyElems,s=0|o.topmargin,c=n.onYScroll(function(t,e,i){for(var r=null,u=o.spies,a=0;a<l.length;a++){var f=l[a],d=u[f.id];if(d.clear(),void 0!==f.getBoundingClientRect().top){var h=f.getBoundingClientRect().top;s>=h?(d.pos=h,null===r&&(r=d),r.pos<d.pos&&(r=d)):null===r&&(r=d)}}i.height+t>=i.maxHeight&&(r=u[l[l.length-1].id]),r.set(),o.$on("destroy",function(){n.removeHandler(c)})})}};return{restrict:"A",scope:{selector:"@",topmargin:"@"},link:o}}]),n.directive("pagemenu",["$compile","$location","$anchorScroll",function(t,n,o){var i=function(i,r){for(var l,s=[],c=[],u=function(t){for(var e={link:t.id,text:t.textContent||t.innerText,parent:""},n=t.tagName,o=0;o<t.classList.length;o++)n+=","+t.classList[o];var i=s.length;if(0===i)s.push(n);else if(n!==s[i-1]){for(var r=i-1;r>=0&&n!=s[r];r--);if(0>r)s.push(n),e.push=!0,c.push(l);else for(e.pop=i-1-r;s.length>r+1;)s.pop(),c.pop()}return c.length>0&&(e.parent=c[c.length-1]),l=e.link,e},a=e().items(),f="",d=0;d<a.length;d++){var h=u(a[d]);if(h.push)f+='<menu class="nav">';else if(h.pop)for(var p=0;p<h.pop;p++)f+="</li></menu>";else 0!==d&&(f+="</li>");f+='<li pagemenuspy="'+h.link+'" parent="'+h.parent+'">',f+='<a href="#'+h.link+'">',f+=h.text,f+="</a>"}f+="</li>",r.append(t(f)(i)),r.on("click",function(t){var i=t.target.hash.substring(1);n.hash(i),o(),0!==e().topMargin()&&setTimeout(function(){window.scrollTo(window.pageXOffset,window.pageYOffset-e().topMargin())},0)})};return{restrict:"E",replace:!0,template:'<menu class="nav pagemenu"></menu>',link:function(t,n){e().setBuilder(function(){i(t,n)})}}}]),n.directive("pagemenuspy",["$location","$anchorScroll",function(t,n){return{restrict:"A",link:function(t,n,o){e().addSpy({id:o.pagemenuspy,parent:o.parent,set:function(){n.addClass("active");var t=e().getSpy(this.parent);t&&t.set()},clear:function(){n.removeClass("active")}})}}}])}(angular);